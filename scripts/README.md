# å¡ç‰‡å›è°ƒæµ‹è¯•å·¥å…·

## åŠŸèƒ½è¯´æ˜

æ­¤è„šæœ¬ç”¨äºç‹¬ç«‹æµ‹è¯•é£ä¹¦å¡ç‰‡å›è°ƒåŠŸèƒ½ï¼Œæ— éœ€ä¾èµ– Claude Code Hook è§¦å‘ã€‚

## ä½¿ç”¨æ–¹æ³•

### 1. ç¡®ä¿æœåŠ¡å™¨è¿è¡Œ

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
npm run dev
```

### 2. è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
npm run test:card
```

### 3. åœ¨é£ä¹¦ä¸­æµ‹è¯•

1. æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨å‘é€ä¸€å¼ æµ‹è¯•å¡ç‰‡åˆ°é…ç½®çš„é£ä¹¦ç¾¤
2. åœ¨é£ä¹¦ä¸­æ‰“å¼€è¯¥ç¾¤ï¼Œæ‰¾åˆ°æµ‹è¯•å¡ç‰‡
3. ç‚¹å‡»ä»»æ„æˆæƒæŒ‰é’®
4. è§‚å¯Ÿå¡ç‰‡æ›´æ–°ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
   - æŒ‰é’®æ¶ˆå¤±
   - å†³ç­–ä¿¡æ¯ï¼ˆå…è®¸/æ‹’ç»ï¼‰
   - è¯¦ç»†çš„å›è°ƒæ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰
   - æœåŠ¡å™¨æ¥æ”¶çŠ¶æ€

## é¢„æœŸæ•ˆæœ

### ç‚¹å‡»å‰

```
ğŸ§ª [æµ‹è¯•] å¡ç‰‡å›è°ƒæµ‹è¯•
è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•å¡ç‰‡å›è°ƒåŠŸèƒ½çš„æµ‹è¯•å¡ç‰‡ã€‚è¯·ç‚¹å‡»ä»»æ„æŒ‰é’®æµ‹è¯•å›è°ƒæ•°æ®æ˜¾ç¤ºã€‚
å‘½ä»¤: `npm test`
[å…è®¸ä¸€æ¬¡] [æ‹’ç»] [æ­¤é¡¹ç›®æ€»æ˜¯å…è®¸] [æ€»æ˜¯å…è®¸]
```

### ç‚¹å‡»"å…è®¸ä¸€æ¬¡"å

```
âœ… å·²æˆæƒ

å†³ç­–: âœ… å…è®¸
é€‰é¡¹: å…è®¸ä¸€æ¬¡
è¯·æ±‚ID: `565f2dda-de5b...`
ä¼šè¯ID: `test-ses`
æ“ä½œæ—¶é—´: 2026-02-09 23:25:43

å›è°ƒæ•°æ®:
{
  "requestId": "565f2dda-de5b-45bf-b13a-0a3b3dff492f",
  "action": "allow_once",
  "sessionId": "test-session-123",
  "decision": "allow",
  "timestamp": "2026-02-09T15:25:43.123Z",
  "operator": "ou_xxx"
}

æœåŠ¡å™¨çŠ¶æ€: âœ… å·²æˆåŠŸæ¥æ”¶å¹¶å¤„ç†
```

## æœåŠ¡å™¨æ—¥å¿—ç¤ºä¾‹

```json
{"ts":"2026-02-09T15:25:43.123Z","level":"info","event":"card_action_raw_event","hasAction":true,"hasOperator":true}
{"ts":"2026-02-09T15:25:43.125Z","level":"info","event":"card_action_value_parsed","value":{...},"hasRequestId":true}
{"ts":"2026-02-09T15:25:43.126Z","level":"info","event":"card_action_received","requestId":"565f2dda..."}
```

## æ•…éšœæ’é™¤

### å¡ç‰‡æœªæ”¶åˆ°

- æ£€æŸ¥ `.env` ä¸­çš„ `FEISHU_TARGET_ID` é…ç½®
- ç¡®è®¤é£ä¹¦ App æœ‰æƒé™å‘é€æ¶ˆæ¯åˆ°è¯¥ç¾¤

### ç‚¹å‡»æŒ‰é’®æ— ååº”

- æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰ `card_action_received` äº‹ä»¶
- ç¡®è®¤ WebSocket é•¿è¿æ¥æ¨¡å¼å·²å¯ç”¨ï¼ˆ`FEISHU_USE_LONG_CONNECTION=true`ï¼‰
- æ£€æŸ¥é£ä¹¦åå°äº‹ä»¶è®¢é˜…é…ç½®

### å¡ç‰‡æ˜¾ç¤ºå¼‚å¸¸

- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ä¸­çš„ `card_action_missing_request_id` æˆ– `card_action_invalid_value` äº‹ä»¶
- å¡ç‰‡ä¼šæ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¥æ”¶åˆ°çš„åŸå§‹æ•°æ®

## ç›¸å…³æ–‡ä»¶

- `scripts/test-card-callback.ts` - æµ‹è¯•è„šæœ¬
- `apps/server/src/feishu/event-handlers.ts` - å¡ç‰‡å›è°ƒå¤„ç†é€»è¾‘
- `apps/server/src/feishu/message.ts` - å¡ç‰‡æ„å»ºå’Œå‘é€
- `apps/server/src/store/auth-store.ts` - æˆæƒè¯·æ±‚çŠ¶æ€ç®¡ç†
